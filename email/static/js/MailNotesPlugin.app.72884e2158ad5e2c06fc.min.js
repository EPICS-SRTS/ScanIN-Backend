webpackJsonp([10],{304:function(e,s,t){(function(s){"use strict";e.exports=function(e){var i=t(2),n=t(44),o=t(184),a=t(182),r=a.getUserRole()===Enums.UserRole.NormalUser,u="Notes";return r?{start:function(e){s("html").addClass("MailNotesPlugin"),a.subscribeEvent("MailWebclient::ConstructView::before",function(s){if("CMailView"===s.Name){var a=s.MailCache.folderList,r=n.computed(function(){return s.MailCache.folderList().currentFolder()}),l=t(305),c=new l(s.MailCache,i.bind(s.View.routeMessageView,s.View));r.subscribe(function(){var t=a().sNamespaceFolder,i=a().sDelimiter,n=r()?r().fullName():"";""!==t&&(u=t+i+"Notes"),n===u?(s.View.setCustomPreviewPane("MailNotesPlugin",c),s.View.setCustomBigButton("MailNotesPlugin",function(){e.run("MailWebclient","setCustomRouting",[n,1,"","","","create-note"])},o.i18n("MAILNOTESPLUGIN/ACTION_NEW_NOTE")),s.View.resetDisabledTools("MailNotesPlugin",["spam","move","mark"])):(s.View.removeCustomPreviewPane("MailNotesPlugin"),s.View.removeCustomBigButton("MailNotesPlugin"),s.View.resetDisabledTools("MailNotesPlugin",[]))})}}),a.subscribeEvent("MailWebclient::ConstructView::after",function(e){if("CMessageListView"===e.Name&&e.MailCache){var s=n.computed(function(){return e.MailCache.folderList().currentFolder()});s.subscribe(function(){var t=s()?s().fullName():"";t===u?e.View.customMessageItemViewTemplate("MailNotesPlugin_MessageItemView"):e.View.customMessageItemViewTemplate("")})}}),a.subscribeEvent("MailWebclient::MessageDblClick::before",i.bind(function(e){e.Message&&e.Message.folder()===u&&(e.Cancel=!0)},this))}}:null}}).call(s,t(1))},305:function(e,s,t){"use strict";function i(e){if("string"!=typeof e)return"";var s=function(e,s,t){var i=s.replace(/(\w{3,4}:\/\/)(.*)/,"$2");return s===t||i===t?s:t+" ("+s+")"};return e.replace(/\r\n/g," ").replace(/\n/g," ").replace(/<style[^>]*>[^<]*<\/style>/gi,"\n").replace(/<br *\/{0,1}>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/(<\/div>)*$/,"").replace(/<(\/div>)+/gi,"\n").replace(/<a [^>]*href="([^"]*?)"[^>]*>(.*?)<\/a>/gi,s).replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"')}function n(e,s){h=e,this.fRouteMessageView=s,this.currentMessage=h.currentMessage,this.currentMessage.subscribe(this.onCurrentMessageSubscribe,this),this.messageText=r.observable(""),this.messageText.focused=r.observable(!1),r.computed(function(){this.messageText(),this.messageText.focused(!0)},this).extend({throttle:5}),this.sMessageUid="",this.sMessageText="",this.isLoading=r.observable(!1),this.isSaving=r.observable(!1),this.createMode=r.observable(!1),this.saveButtonText=r.computed(function(){return this.isSaving()?u.i18n("COREWEBCLIENT/ACTION_SAVE_IN_PROGRESS"):u.i18n("COREWEBCLIENT/ACTION_SAVE")},this),this.bBinded=!1}var o=t(2),a=t(1),r=t(44),u=t(184),l=t(190),c=t(185),g=t(42),h=null;n.prototype.ViewTemplate="MailNotesPlugin_MessagePaneView",n.prototype.ViewConstructorName="CMessagePaneView",n.prototype.onShow=function(){this.bShown=!0},n.prototype.onHide=function(){this.bShown=!1},n.prototype.hasUnsavedChanges=function(){var e=this.currentMessage();return(!e||this.sMessageUid===e.uid())&&this.sMessageText!==this.messageText()},n.prototype.discardChanges=function(){this.currentMessage()||(this.sMessageUid="",this.sMessageText="",this.messageText(""))},n.prototype.getSubjectFromText=function(e){var s=e.split(/\r\n|\n/i),t=o.find(s,function(e){return""!==a.trim(e)});return t=a.trim(t),t.length>50&&(t=t.substring(0,50)),t},n.prototype.onCurrentMessageSubscribe=function(){var e=this.currentMessage();if(e){if(e.isPlain()?this.messageText(e.textRaw()):this.messageText(i(e.textRaw())),this.sMessageUid=e.uid(),this.sMessageText=this.messageText(),this.isLoading(""!==e.uid()&&!e.completelyFilled()),!e.completelyFilled())var s=e.completelyFilled.subscribe(function(){this.onCurrentMessageSubscribe(),s.dispose()},this);this.isSaving(!1)}else this.sMessageUid="",this.sMessageText="",this.messageText("")},n.prototype.onBind=function(e){this.bBinded||(g.run("SessionTimeoutWeblient","registerFunction",[o.bind(function(){this.saveNote()},this)]),a(document).on("keydown",a.proxy(function(e){e.ctrlKey&&e.keyCode===Enums.Key.s&&(e.preventDefault(),this.saveNote())},this)),this.bBinded=!0)},n.prototype.onRoute=function(e,s){h.setCurrentMessage(s.Uid,s.Folder),"create-note"===s.Custom?(this.messageText(""),this.createMode(!0)):this.createMode(!1),this.isSaving(!1)},n.prototype.saveNote=function(){this.createMode()?this.saveNewNote():this.saveEditedNote()},n.prototype.saveNewNote=function(){var e=h.getCurrentFolder(),s={AccountId:h.currentAccountId(),FolderFullName:e.fullName(),Text:this.messageText().replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())};this.isSaving(!0),this.sMessageText=this.messageText(),l.send("MailNotesPlugin","SaveNote",s,function(e){if(this.isSaving(!1),e.Result){if(this.bShown)var t=h.messagesLoading.subscribe(function(){!this.bShown||h.messagesLoading()||this.currentMessage()||(this.fRouteMessageView(s.FolderFullName,e.Result),t.dispose())},this)}else c.showErrorByCode(e,u.i18n("MAILNOTESPLUGIN/ERROR_NOTE_SAVING"));h.executeCheckMail(!0)},this)},n.prototype.saveEditedNote=function(e){if(e||(e=this.currentMessage()),e){var s={AccountId:h.currentAccountId(),FolderFullName:e.folder(),MessageUid:e.uid(),Text:this.messageText().replace(/\n/g,"<br />").replace(/\r\n/g,"<br />"),Subject:this.getSubjectFromText(this.messageText())},t=h.getFolderByFullName(h.currentAccountId(),e.folder());t.markDeletedByUids([e.uid()]),h.excludeDeletedMessages(),this.isSaving(!0),this.sMessageText=this.messageText(),l.send("MailNotesPlugin","SaveNote",s,function(e){if(this.isSaving(!1),e.Result){if(this.bShown)var t=h.messagesLoading.subscribe(function(){!this.bShown||h.messagesLoading()||this.currentMessage()||(this.fRouteMessageView(s.FolderFullName,e.Result),t.dispose())},this)}else c.showErrorByCode(e,u.i18n("MAILNOTESPLUGIN/ERROR_NOTE_SAVING"));h.executeCheckMail(!0)},this)}},n.prototype.cancel=function(){this.sMessageText=this.messageText(),g.run("MailWebclient","setCustomRouting",["Notes",1,"","","",""])},e.exports=n}});